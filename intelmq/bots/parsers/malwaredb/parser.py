# -*- coding: utf-8 -*-
"""
DanParserBot parses data from http://malwaredb.malekal.com/export.php?type=url.

"""

from intelmq.lib.bot import ParserBot
import xml.etree.ElementTree as ET
from intelmq.lib import utils
from datetime import datetime

class MalwareDBParserBot(ParserBot):
    def process(self):
        report = self.receive_message()
        raw_report = utils.base64_decode(report.get('raw'))
        e = ET.fromstring(str(raw_report))
        for item in e.findall('item'):
            try:
                event = self.new_event(report)
                event.add('time.source', item[0].text+"+00:00")
                event.add('source.fqdn', item[1].text)
                event.add('source.url', item[2].text)
                event.add('source.ip', item[3].text)
                event.add('comment', item[4].text)
                event.add('raw', str(item[0].text+"+00:00")+"|"+str(item[1].text)+"|"+str(item[2].text)+"|"+str(item[3].text)+"|"+str(item[4].text))
                self.send_message(event)
            except:
                pass
        self.acknowledge_message()
BOT = MalwareDBParserBot